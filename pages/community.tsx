import Head from "next/head";
import {
  Flex,
  IconButton,
  Img,
  useTheme,
  Container,
  Box,
} from "@chakra-ui/react";
import { NextPageContext } from "next";

import { useEffect, useMemo } from "react";
import { useSetRecoilState } from "recoil";
import { AuthAtom, User } from "recoilStore/AuthAtom";
import axios from "axios";
// import Container from '@/components/Container'
import Layout from "@/components/Layout";
import CommunityContentLayout from "@/components/Dashboard/CommunityContentLayout";
import CommunityLeftSidebar from "@/components/Dashboard/CommunityLeftSidebar";
import CommunityRightSidebar from "@/components/Dashboard/CommunityRightSidebar";
import CommunityMainContent from "@/components/Dashboard/CommunityMainContent";
import withAuth from "middleware/withAuth";
import { endpoint } from "api_routes";
import { Post, PostsAtom } from "recoilStore/PostsAtom";

function community(props: any) {
  const theme = useTheme();
  const setAuth = useSetRecoilState(AuthAtom);
  const setPost = useSetRecoilState(PostsAtom);
  const { secondaryBlack } = theme.colors.brand;

  useEffect(() => {
    if (props.initialRecoilState?.user) {
      setAuth({
        token: props?.initialRecoilState?.user?.token,
        refreshToken: props?.initialRecoilState?.user?.refreshToken,
        ...props?.initialRecoilState?.user,
      });
    }
  }, [props.initialRecoilState?.user]);

  useEffect(() => {
    if (props.initialRecoilState?.posts) {
      setPost(props.initialRecoilState?.posts);
    }
  }, [props.initialRecoilState?.posts]);

  // useMemo(() => {
  //   const context = typeof window !== "undefined" ? "client" : "server";
  //   console.log(`<${context}> [initialRecoilState]`, props.initialRecoilState);

  //   initialRecoilState = props.initialRecoilState; // Overwrite the global mutable variable
  // }, []);

  return (
    <div>
      <Head>
        <title>Welcome - Community</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Layout>
        <Box bg={secondaryBlack["200"]}>
          <Container
            maxW="120em"
            px={{ base: "1rem", lg: "4rem" }}
            bg={secondaryBlack["300"]}
          >
            <CommunityContentLayout>
              <CommunityLeftSidebar />
              <CommunityMainContent />
              <CommunityRightSidebar />
            </CommunityContentLayout>
          </Container>
        </Box>
      </Layout>
    </div>
  );
}

export default community;

export const getServerSideProps = withAuth(
  async (context: NextPageContext & { user: User }) => {
    let user: User | null = null;
    let posts: Array<Post> | null = null;

    if (context?.user) {
      user = context.user;

      try {
        const response = await axios.get(endpoint.POSTS, {
          headers: {
            Authorization: `Bearer ${user.token}`,
            "x-refresh-token": user.refreshToken,
          },
        });

        if (response.status === 200) {
          posts = response.data?.message?.posts;
        }
      } catch (error) {}
    }

    return {
      props: {
        initialRecoilState: { user, posts },
      },
    };
  }
);
